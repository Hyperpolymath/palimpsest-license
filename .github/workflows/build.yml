name: Build All Components

# Comprehensive build workflow for all Palimpsest License components
# Compiles SCSS, builds validators, converts assets, and uploads artefacts

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  release:
    types: [published]

jobs:
  build-styles:
    name: SCSS ‚Üí CSS Compilation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CSS from SCSS (production)
        run: npm run scss:build

      - name: Verify CSS output
        run: |
          if [ ! -f "styles/css/main.css" ]; then
            echo "‚ùå CSS build failed - output file not found"
            exit 1
          fi
          echo "‚úÖ CSS built successfully"

      - name: Upload CSS artefacts
        uses: actions/upload-artifact@v4
        with:
          name: compiled-css
          path: |
            styles/css/*.css
          retention-days: 30

  build-haskell:
    name: Build Haskell Validators
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.6.3'
          cabal-version: '3.10'

      - name: Cache Cabal dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            TOOLS/validation/haskell/dist-newstyle
          key: ${{ runner.os }}-cabal-${{ hashFiles('**/cabal.project', '**/palimpsest-validator.cabal') }}
          restore-keys: |
            ${{ runner.os }}-cabal-

      - name: Update Cabal
        working-directory: TOOLS/validation/haskell
        run: cabal update

      - name: Build Haskell validators (release mode)
        working-directory: TOOLS/validation/haskell
        run: cabal build --enable-optimization=2

      - name: Find and copy executable
        shell: bash
        run: |
          mkdir -p build-output
          # Find the built executable
          if [ -d "TOOLS/validation/haskell/dist-newstyle" ]; then
            find TOOLS/validation/haskell/dist-newstyle -type f -executable -name "palimpsest-validator*" -exec cp {} build-output/ \; || echo "No executables found yet"
          fi

      - name: Upload Haskell binaries
        uses: actions/upload-artifact@v4
        with:
          name: haskell-validator-${{ matrix.os }}
          path: build-output/*
          retention-days: 30
          if-no-files-found: warn

  build-rescript:
    name: Build ReScript Components
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install ReScript dependencies
        working-directory: rescript
        run: npm ci

      - name: Build ReScript components
        working-directory: rescript
        run: npm run build

      - name: Verify ReScript build
        run: |
          if [ ! -d "rescript/lib" ]; then
            echo "‚ùå ReScript build failed"
            exit 1
          fi
          echo "‚úÖ ReScript built successfully"

      - name: Upload ReScript artefacts
        uses: actions/upload-artifact@v4
        with:
          name: rescript-compiled
          path: |
            rescript/lib/**/*.js
            rescript/lib/**/*.d.ts
          retention-days: 30

  build-documentation:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate table of contents for key docs
        run: |
          echo "Generating TOCs..."
          npx markdown-toc -i README.md || echo "No TOC markers in README.md"
          npx markdown-toc -i GOVERNANCE.md || echo "No TOC markers in GOVERNANCE.md"
          npx markdown-toc -i CONTRIBUTING.md || echo "No TOC markers in CONTRIBUTING.md"

      - name: Validate documentation links
        run: |
          echo "Validating internal documentation links..."
          # This is a basic check - full validation in rsr-compliance.yml
          find docs -name "*.md" -exec grep -l "\[.*\](.*)" {} \; | head -10

      - name: Bundle documentation metadata
        run: |
          echo "Bundling documentation..."
          mkdir -p build-output/docs

          # Copy key documentation files
          cp README.md build-output/docs/ || true
          cp CLAUDE.md build-output/docs/ || true
          cp GOVERNANCE.md build-output/docs/ || true
          cp -r GUIDES_v0.4 build-output/docs/ || true
          cp -r docs build-output/docs/reference || true

          echo "‚úÖ Documentation bundled"

      - name: Upload documentation bundle
        uses: actions/upload-artifact@v4
        with:
          name: documentation-bundle
          path: build-output/docs
          retention-days: 30

  convert-assets:
    name: Asset Conversion (SVG ‚Üí PNG/JPG/TIFF)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ImageMagick and librsvg
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick librsvg2-bin

      - name: Convert SVG badges to PNG
        run: |
          echo "Converting SVG assets to PNG..."
          mkdir -p build-output/assets

          # Find all SVG files in assets
          if [ -d "assets" ]; then
            for svg in $(find assets -name "*.svg" 2>/dev/null || true); do
              if [ -f "$svg" ]; then
                basename=$(basename "$svg" .svg)
                dirname=$(dirname "$svg")
                outdir="build-output/$dirname"

                mkdir -p "$outdir"

                echo "Converting: $svg"

                # PNG (web)
                rsvg-convert -h 256 "$svg" -o "$outdir/${basename}.png" || echo "Failed to convert $svg to PNG"

                # JPG (compatibility)
                convert "$svg" -resize 256x256 -background white -flatten "$outdir/${basename}.jpg" || echo "Failed to convert $svg to JPG"

                # TIFF (print quality)
                convert "$svg" -resize 1024x1024 "$outdir/${basename}.tiff" || echo "Failed to convert $svg to TIFF"
              fi
            done
          fi

          echo "‚úÖ Asset conversion complete"

      - name: Upload converted assets
        uses: actions/upload-artifact@v4
        with:
          name: converted-assets
          path: build-output/assets
          retention-days: 30
          if-no-files-found: warn

  build-metadata:
    name: Build Metadata Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate and bundle metadata
        run: |
          echo "Building metadata package..."
          mkdir -p build-output/metadata

          # Validate all JSON files first
          for file in $(find METADATA_v0.4 metadata -name "*.json" 2>/dev/null || true); do
            echo "Validating: $file"
            jq empty "$file" || exit 1
          done

          # Copy metadata files
          if [ -d "METADATA_v0.4" ]; then
            cp -r METADATA_v0.4 build-output/metadata/
          fi

          if [ -d "metadata" ]; then
            cp -r metadata/* build-output/metadata/ 2>/dev/null || true
          fi

          echo "‚úÖ Metadata package built"

      - name: Upload metadata package
        uses: actions/upload-artifact@v4
        with:
          name: metadata-package
          path: build-output/metadata
          retention-days: 30

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-styles, build-haskell, build-rescript, build-documentation, convert-assets, build-metadata]
    if: always()
    steps:
      - name: Download all artefacts
        uses: actions/download-artifact@v4
        with:
          path: all-artefacts

      - name: Display build results
        run: |
          echo "============================================"
          echo "üî® BUILD RESULTS"
          echo "============================================"
          echo ""
          echo "CSS compilation: ${{ needs.build-styles.result }}"
          echo "Haskell validators: ${{ needs.build-haskell.result }}"
          echo "ReScript components: ${{ needs.build-rescript.result }}"
          echo "Documentation: ${{ needs.build-documentation.result }}"
          echo "Asset conversion: ${{ needs.convert-assets.result }}"
          echo "Metadata package: ${{ needs.build-metadata.result }}"
          echo ""

          echo "Built artefacts:"
          find all-artefacts -type f | head -20
          echo ""
          echo "============================================"

          # Fail if critical builds failed
          if [ "${{ needs.build-styles.result }}" != "success" ] || \
             [ "${{ needs.build-rescript.result }}" != "success" ] || \
             [ "${{ needs.build-documentation.result }}" != "success" ]; then
            echo "‚ùå Critical builds failed"
            exit 1
          fi

          echo "‚úÖ Build complete"

      - name: Upload combined artefacts (release only)
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: palimpsest-license-build-${{ github.sha }}
          path: all-artefacts
          retention-days: 90
