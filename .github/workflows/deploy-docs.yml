name: Deploy Documentation to GitHub Pages

# Deploys documentation and compiled assets to GitHub Pages
# Includes CSS compilation, documentation bundling, and asset optimization

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-docs:
    name: Build Documentation Site
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CSS from SCSS
        run: npm run scss:build

      - name: Create documentation structure
        run: |
          echo "Building documentation site..."
          mkdir -p _site

          # Copy root documentation files
          cp README.md _site/index.md || cp README.md _site/
          cp GOVERNANCE.md _site/ || true
          cp CONTRIBUTING.md _site/ || true
          cp CODE_OF_PRACTICE.md _site/ || true
          cp SECURITY.md _site/ || true
          cp CHANGELOG.md _site/ || true

          # Copy license files
          mkdir -p _site/licenses
          cp -r LICENSES/* _site/licenses/ || true

          # Copy guides
          mkdir -p _site/guides
          cp -r GUIDES_v0.4/* _site/guides/ 2>/dev/null || true

          # Copy documentation
          mkdir -p _site/docs
          cp -r docs/* _site/docs/ 2>/dev/null || true

          # Copy examples
          mkdir -p _site/examples
          cp -r examples/* _site/examples/ 2>/dev/null || true

          # Copy press kit
          mkdir -p _site/press
          cp -r press-lobby-kit/* _site/press/ 2>/dev/null || true

          echo "‚úÖ Documentation structure created"

      - name: Copy compiled CSS
        run: |
          mkdir -p _site/styles/css
          cp styles/css/*.css _site/styles/css/ 2>/dev/null || true
          cp style.css _site/styles/ 2>/dev/null || true

      - name: Copy assets
        run: |
          mkdir -p _site/assets
          cp -r assets/* _site/assets/ 2>/dev/null || true

          mkdir -p _site/embed
          cp -r embed/* _site/embed/ 2>/dev/null || true

      - name: Copy special files
        run: |
          # Copy .well-known directory for security.txt, etc.
          mkdir -p _site/.well-known
          cp -r .well-known/* _site/.well-known/ 2>/dev/null || true

          # Copy humans.txt, robots.txt
          cp humans.txt _site/ 2>/dev/null || true
          cp robots.txt _site/ 2>/dev/null || true
          cp trust.txt _site/ 2>/dev/null || true

          # Copy .nojekyll to disable Jekyll processing
          touch _site/.nojekyll

      - name: Generate index.html
        run: |
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Palimpsest License - Documentation</title>
              <link rel="stylesheet" href="styles/css/main.css">
              <link rel="stylesheet" href="styles/style.css">
              <meta name="description" content="A future-proof license for creative work in the age of AI">
              <meta name="keywords" content="license, AI, creative commons, copyright, emotional lineage">
          </head>
          <body>
              <header>
                  <h1>Palimpsest License</h1>
                  <p>A future-proof license for creative work in the age of AI</p>
              </header>

              <main>
                  <section>
                      <h2>Documentation</h2>
                      <ul>
                          <li><a href="index.md">README</a></li>
                          <li><a href="licenses/">License Texts</a></li>
                          <li><a href="guides/">User Guides</a></li>
                          <li><a href="docs/">Technical Documentation</a></li>
                          <li><a href="examples/">Examples & Vignettes</a></li>
                      </ul>
                  </section>

                  <section>
                      <h2>Governance & Community</h2>
                      <ul>
                          <li><a href="GOVERNANCE.md">Governance Model</a></li>
                          <li><a href="CONTRIBUTING.md">Contributing Guidelines</a></li>
                          <li><a href="CODE_OF_PRACTICE.md">Code of Practice</a></li>
                          <li><a href="SECURITY.md">Security Policy</a></li>
                      </ul>
                  </section>

                  <section>
                      <h2>Resources</h2>
                      <ul>
                          <li><a href="press/">Press & Advocacy Kit</a></li>
                          <li><a href=".well-known/security.txt">security.txt</a></li>
                          <li><a href="humans.txt">humans.txt</a></li>
                      </ul>
                  </section>
              </main>

              <footer>
                  <p>&copy; 2024-2025 Palimpsest Stewardship Council</p>
                  <p>This is a license born not just from copyright, but from care.</p>
              </footer>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: '_site'

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "============================================"
          echo "üåê DOCUMENTATION DEPLOYED"
          echo "============================================"
          echo ""
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "‚úÖ Deployment complete"
