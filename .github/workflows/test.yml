name: Test Suite

# Comprehensive test suite for Palimpsest License validation tools
# Runs Haskell, ReScript, and integration tests with coverage reporting

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test-haskell:
    name: Haskell Validator Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        ghc: ['9.4.8', '9.6.3']
        exclude:
          # Reduce matrix for Windows (slower runners)
          - os: windows-latest
            ghc: '9.4.8'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: ${{ matrix.ghc }}
          cabal-version: '3.10'

      - name: Cache Cabal dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            TOOLS/validation/haskell/dist-newstyle
          key: ${{ runner.os }}-cabal-${{ matrix.ghc }}-${{ hashFiles('**/cabal.project', '**/palimpsest-validator.cabal') }}
          restore-keys: |
            ${{ runner.os }}-cabal-${{ matrix.ghc }}-
            ${{ runner.os }}-cabal-

      - name: Update Cabal package list
        working-directory: TOOLS/validation/haskell
        run: cabal update

      - name: Install dependencies
        working-directory: TOOLS/validation/haskell
        run: cabal build --only-dependencies --enable-tests --enable-benchmarks

      - name: Build Haskell validators
        working-directory: TOOLS/validation/haskell
        run: cabal build --enable-tests --enable-benchmarks

      - name: Run Haskell tests
        working-directory: TOOLS/validation/haskell
        run: cabal test --test-show-details=direct

      - name: Generate Haskell test coverage
        if: matrix.os == 'ubuntu-latest' && matrix.ghc == '9.6.3'
        working-directory: TOOLS/validation/haskell
        run: |
          cabal test --enable-coverage
          cabal haddock --haddock-html --haddock-hoogle

  test-rescript:
    name: ReScript Component Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: ['18', '20']
        exclude:
          - os: windows-latest
            node: '18'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Cache ReScript dependencies
        uses: actions/cache@v4
        with:
          path: |
            rescript/node_modules
            rescript/lib
          key: ${{ runner.os }}-rescript-${{ matrix.node }}-${{ hashFiles('rescript/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-rescript-${{ matrix.node }}-
            ${{ runner.os }}-rescript-

      - name: Install ReScript dependencies
        working-directory: rescript
        run: npm ci

      - name: Build ReScript components
        working-directory: rescript
        run: npm run build

      - name: Run ReScript tests
        working-directory: rescript
        run: npm test

      - name: Type check ReScript
        working-directory: rescript
        run: npx rescript build -with-deps

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install just command runner
        uses: extractions/setup-just@v2

      - name: Install dependencies
        run: npm ci

      - name: Install jq (JSON processor)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run integration tests
        run: just test-integration

      - name: Test metadata validation pipeline
        run: |
          echo "Testing metadata validation..."

          # Validate all JSON metadata files
          for file in $(find METADATA_v0.4 -name "*.json" 2>/dev/null || true); do
            echo "Validating: $file"
            jq empty "$file" || exit 1
          done

          # Check Dublin Core metadata structure
          if [ -f "METADATA_v0.4/dublin-core/palimpsest-v0.4-dc.json" ]; then
            DC_FILE="METADATA_v0.4/dublin-core/palimpsest-v0.4-dc.json"
            echo "Checking Dublin Core required fields..."

            jq -e '.title' "$DC_FILE" || { echo "Missing: title"; exit 1; }
            jq -e '.creator' "$DC_FILE" || { echo "Missing: creator"; exit 1; }
            jq -e '.date' "$DC_FILE" || { echo "Missing: date"; exit 1; }

            echo "‚úÖ Dublin Core metadata valid"
          fi

      - name: Test license text structure
        run: |
          echo "Testing license text structure..."

          LICENSE_FILE="LICENSES/v0.4/palimpsest-v0.4.md"
          if [ ! -f "$LICENSE_FILE" ]; then
            echo "‚ùå License file not found: $LICENSE_FILE"
            exit 1
          fi

          # Check for key clauses
          grep -q "Clause 1\.2" "$LICENSE_FILE" || { echo "Missing Clause 1.2 (NI systems)"; exit 1; }
          grep -q "Clause 2\.3" "$LICENSE_FILE" || { echo "Missing Clause 2.3 (metadata)"; exit 1; }

          echo "‚úÖ License structure valid"

      - name: Test SPDX header presence
        run: |
          echo "Testing SPDX headers in source files..."

          # Check Haskell files
          if [ -d "TOOLS/validation/haskell/src" ]; then
            HS_COUNT=$(find TOOLS/validation/haskell/src -name "*.hs" | wc -l)
            SPDX_COUNT=$(grep -r "SPDX-License-Identifier: Palimpsest-0.4" TOOLS/validation/haskell/src --include="*.hs" | wc -l)

            echo "Haskell files: $HS_COUNT"
            echo "Files with SPDX: $SPDX_COUNT"

            if [ "$HS_COUNT" -gt 0 ] && [ "$SPDX_COUNT" -eq "$HS_COUNT" ]; then
              echo "‚úÖ All Haskell files have SPDX headers"
            fi
          fi

  coverage:
    name: Coverage Reporting
    runs-on: ubuntu-latest
    needs: [test-haskell, test-rescript, test-integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.6.3'
          cabal-version: '3.10'

      - name: Install dependencies
        run: |
          npm ci
          cd TOOLS/validation/haskell && cabal update && cabal build --only-dependencies --enable-coverage

      - name: Generate Haskell coverage
        working-directory: TOOLS/validation/haskell
        run: |
          cabal test --enable-coverage
          # Generate HPC report
          mkdir -p coverage
          find dist-newstyle -name "*.tix" -exec cp {} coverage/ \; || true

      - name: Generate ReScript coverage
        working-directory: rescript
        run: |
          npm ci
          # ReScript coverage would go here if configured
          echo "ReScript coverage: TBD"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./TOOLS/validation/haskell/coverage/*.tix
          flags: unittests
          name: codecov-palimpsest
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-haskell, test-rescript, test-integration]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "============================================"
          echo "üß™ TEST SUITE RESULTS"
          echo "============================================"
          echo ""
          echo "Haskell tests: ${{ needs.test-haskell.result }}"
          echo "ReScript tests: ${{ needs.test-rescript.result }}"
          echo "Integration tests: ${{ needs.test-integration.result }}"
          echo ""
          echo "============================================"

          if [ "${{ needs.test-haskell.result }}" != "success" ] || \
             [ "${{ needs.test-rescript.result }}" != "success" ] || \
             [ "${{ needs.test-integration.result }}" != "success" ]; then
            echo "‚ùå Some tests failed"
            exit 1
          fi

          echo "‚úÖ All tests passed"
